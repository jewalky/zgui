class Drawer ui
{
	double VirtualX;
	double VirtualY;
	double VirtualWidth;
	double VirtualHeight;
	
	double ClipLeft;
	double ClipRight;
	double ClipTop;
	double ClipBottom;
	double Scale;

	static Drawer Create(Element el)
	{
		Drawer d = new ('Drawer');
		// calculate screen x/y.
		Rect sr = el.GetScreenRect();
		d.ClipLeft = sr.GetLeft();
		d.ClipRight = sr.GetRight();
		d.ClipTop = sr.GetTop();
		d.ClipBottom = sr.GetBottom();
		// get final scale to set virtualwidth/virtualheight
		d.VirtualWidth = Screen.GetWidth();
		d.VirtualHeight = Screen.GetHeight();
		d.VirtualX = d.ClipLeft;
		d.VirtualY = d.ClipTop;
		d.Scale = 1.0;
		Element p = el;
		while (p)
		{
			d.VirtualWidth /= p.mScale;
			d.VirtualHeight /= p.mScale;
			d.VirtualX /= p.mScale;
			d.VirtualY /= p.mScale;
			d.Scale *= p.mParent?p.mParent.mScale:1;
			p = p.mParent;
		}
		
		return d;
	}
	
	void DrawTexture(TextureID tex, bool animated, double x, double y)
	{
		Screen.DrawTexture(tex, animated, VirtualX+x, VirtualY+y,
		
			DTA_VirtualWidth, int(VirtualWidth),
			DTA_VirtualHeight, int(VirtualHeight),
			DTA_KeepRatio, true,
			DTA_ClipTop, int(ClipTop),
			DTA_ClipLeft, int(ClipLeft),
			DTA_ClipBottom, int(ClipBottom),
			DTA_ClipRight, int(ClipRight)
		
		);
	}
	
	void DrawChar(Font font, int normalcolor, double x, double y, int character)
	{
		Screen.DrawChar(font, normalcolor, VirtualX+x, VirtualY+y, character,
		
			DTA_VirtualWidth, int(VirtualWidth),
			DTA_VirtualHeight, int(VirtualHeight),
			DTA_KeepRatio, true,
			DTA_ClipTop, int(ClipTop),
			DTA_ClipLeft, int(ClipLeft),
			DTA_ClipBottom, int(ClipBottom),
			DTA_ClipRight, int(ClipRight)
		
		);
	}
	
	void DrawText(Font font, int normalcolor, double x, double y, String text)
	{
		Screen.DrawText(font, normalcolor, VirtualX+x, VirtualY+y, text,
			
			DTA_VirtualWidth, int(VirtualWidth),
			DTA_VirtualHeight, int(VirtualHeight),
			DTA_KeepRatio, true,
			DTA_ClipTop, int(ClipTop),
			DTA_ClipLeft, int(ClipLeft),
			DTA_ClipBottom, int(ClipBottom),
			DTA_ClipRight, int(ClipRight)
			
		);
	}
	
	private Rect ConvertRect(Rect r)
	{
		Rect or = r.Clone();
		// convert virtual to real
		or.X += VirtualX;
		or.Y += VirtualY;
		or.X *= Scale;
		or.Y *= Scale;
		or.Width *= Scale;
		or.Height *= Scale;
		// clamp
		if (or.X < ClipLeft)
		{
			or.Width -= (ClipLeft-or.X);
			or.X = ClipLeft;
		}
		if (or.Y < ClipTop)
		{
			or.Height -= (ClipTop-or.Y);
			or.Y = ClipTop;
		}
		if (or.X+or.Width > ClipRight)
		{
			or.Width = ClipRight-or.X;
		}
		if (or.Y+or.Height > ClipBottom)
		{
			or.Height = ClipBottom-or.Y;
		}
		return or;
	}
	
	void DrawFrame(int x, int y, int w, int h)
	{
		Rect cr = ConvertRect(Rect.FromXYWH(x, y, w, h));
		if (cr.Width <= 0 || cr.Height <= 0) return;
		Screen.DrawFrame(cr.X, cr.Y, cr.Width, cr.Height);
	}
	
	void Dim(Color col, double alpha, int x, int y, int w, int h)
	{
		Rect cr = ConvertRect(Rect.FromXYWH(x, y, w, h));
		if (cr.Width <= 0 || cr.Height <= 0) return;
		Screen.Dim(col, alpha, cr.X, cr.Y, cr.Width, cr.Height);
	}
	
	void Clear(Color col, int x, int y, int w, int h, int palcolor = -1)
	{
		Rect cr = ConvertRect(Rect.FromXYWH(x, y, w, h));
		if (cr.Width <= 0 || cr.Height <= 0) return;
		Screen.Clear(cr.GetLeft(), cr.GetTop(), cr.GetRight(), cr.GetBottom(), col, palcolor);
	}
}